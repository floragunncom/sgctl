variables:
  SG_JAVA_BUILD_VERSION: "21"
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode"
  DOCKER_DRIVER: overlay2
image: "maven:3.9.9-amazoncorretto-21-debian"


include:
- local: 'ci/aikido.yml'  

stages:
  - format
  - build
  - package
  - "Deploy Docker Image"
  - "Aikido Scan"

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS'
      when: never
    - when: always

build:
  stage: build
  interruptible: true
  rules:
    - if: '$CI_COMMIT_TAG =~ /^sgctl-.*/'
      when: never
    - if: '$DOCKER_ONLY'
      when: never            
    - when: always
  script:
    - mvn -Drevision=b-$CI_COMMIT_REF_SLUG-SNAPSHOT $MAVEN_CLI_OPTS clean install
  artifacts:
    when: always
    paths:
      - "target"
      - ".m2/repository/com/floragunn/*"
    reports:
      junit:
        - "target/surefire-reports/TEST-*.xml"
        - "target/failsafe-reports/TEST-*.xml"
    expire_in: 12h
  cache:
    key: mavenrepo
    paths:
      - .m2/repository

build_release:
  stage: build
  interruptible: true
  rules:
    - if: '$DOCKER_ONLY'
      when: never          
    - if: '$CI_COMMIT_TAG =~ /^sgctl-.*/'
  script:
    # $CI_COMMIT_TAG: sgctl-1.0.0-beta-1
    - export SGCTL_RELEASE_VERSION=$(echo $CI_COMMIT_TAG | sed -n 's/^sgctl-\(.*\)/\1/p')  
    - mvn -Drevision=$SGCTL_RELEASE_VERSION $MAVEN_CLI_OPTS clean install
  artifacts:
    when: always
    paths:
      - "*/target"
      - ".m2/repository/com/floragunn/*"
    reports:
      junit:
        - "*/target/surefire-reports/TEST-*.xml"
        - "*/target/failsafe-reports/TEST-*.xml"
    expire_in: 12h
  cache:
    key: mavenrepo
    paths:
      - .m2/repository

coverage:
  stage: package
  rules:
    - if: '$CI_COMMIT_TAG =~ /^sgctl-.*/'
      when: never
    - when: always
  image: registry.gitlab.com/haynes/jacoco2cobertura:1.0.9
  needs: ["build"]
  dependencies:
    - build
  script:
    - python /opt/cover2cover.py target/site/jacoco/jacoco.xml src/main/java/ > target/site/cobertura.xml
    - cat target/site/jacoco/index.html | grep -o '<tfoot>.*</tfoot>'
  coverage: '/Total.*?([0-9]{1,3})%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: target/site/cobertura.xml
        
        
        
deploy_docker_image:
  stage: "Deploy Docker Image"
  image: docker:20.10.17
  services:
    - docker:20.10.17-dind
  rules:
    - if: '$CI_COMMIT_TAG =~ /^sgctl-.*/'
      when: always
    - if: '$DOCKER_ONLY'
      when: on_success
  timeout: 1h
  script:
    - |
      cd docker
      apk update && apk add bash curl 

      export SGCTL_RELEASE_VERSION=$(echo $CI_COMMIT_TAG | sed -n 's/^sgctl-\(.*\)/\1/p')  
      echo "SGCTL_RELEASE_VERSION=$SGCTL_RELEASE_VERSION"
      if [[ -z "$SGCTL_RELEASE_VERSION" ]]; then
        echo "SGCTL_RELEASE_VERSION is empty"
        exit 1
      fi
      echo "Docker logout"
      docker logout 
      
      echo "Login in into Docker Hub"      
      echo "$DOCKER_PASSWORD" | docker login --username floragunncom --password-stdin docker.io > /dev/null

      echo ""
      echo "Enable qemu-user-static to support docker multiarch builds with buildx"
      docker run --rm --privileged multiarch/qemu-user-static --reset -p yes > /dev/null

      ./build_and_push.sh "floragunncom" "docker.io" "search-guard-flx-sgctl" "$SGCTL_RELEASE_VERSION" "--build-arg SGCTL_VERSION="$SGCTL_RELEASE_VERSION" --build-arg JAVA_VERSION=$SG_JAVA_BUILD_VERSION"
  allow_failure: false        


spotless-apply-on-changed-java:
  stage: format
  variables:
    MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  before_script:
    - apt-get update && apt-get install -y git
    - git config --global user.email "gitlab-ci@git.se.uni-hannover.de"
    - git config --global user.name "GitLab CI"
    - git fetch --no-tags --prune origin +refs/heads/*:refs/remotes/origin/*
  script:
    # get changed
    - |
      CHANGED_RAW=$(git diff --name-only --diff-filter=ACM origin/"$CI_MERGE_REQUEST_TARGET_BRANCH_NAME"...HEAD | grep -E '\.java$' || true)
      echo "Changed files from origin/$TARGET_BRANCH to HEAD:"
      echo "$CHANGED_RAW"
      # select only .java files and convert to absolute paths expected by spotless
      CHANGED_JAVA=$(echo "$CHANGED_RAW" | grep '\.java$' || true)
      if [ -z "$CHANGED_JAVA" ]; then
        echo "No changed Java files. Exiting success."
        exit 0
      fi
      FILES_ABS=$(echo "$CHANGED_JAVA" | sed "s|^|$PWD/|" | paste -sd, -)
      echo "Files to format (absolute, comma-separated):"
      echo "$FILES_ABS"
      export SPOTLESS_FILES="$FILES_ABS"
    # apply
    - mvn -B spotless:apply -DspotlessFiles="$SPOTLESS_FILES"
    # push back
    - if [ -n "$(git status --porcelain)" ]; then
        git add -A;
        git commit -m "Apply Spotless [ci skip]" || true;
        REMOTE="https://${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
        git push "https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" HEAD:"${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}" || {
          echo "Push failed. The runner may not have permission to push to the source branch. Exiting with non-zero.";
          exit 2;
        };
      else
        echo "No formatting changes produced by Spotless."
      fi
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always