variables:
  SG_JAVA_BUILD_VERSION: "21"
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode -Pwith-sg-plugin"
  DOCKER_DRIVER: overlay2
image: "maven:3.9.9-amazoncorretto-21-debian"


include:
- local: 'ci/aikido.yml'  

stages:
  - build
  - quality
  - package
  - "Aikido Scan"
  - release
  - "Deploy Docker Image"

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS'
      when: never
    - when: always

build:
  stage: build
  interruptible: true
  rules:
    - if: '$CI_COMMIT_TAG =~ /^sgctl-.*/'
      when: never
    - if: '$DOCKER_ONLY'
      when: never            
    - when: on_success
  script:
    - mvn -Drevision=b-$CI_COMMIT_REF_SLUG-SNAPSHOT $MAVEN_CLI_OPTS clean install
  artifacts:
    when: always
    paths:
      - "target"
      - ".m2/repository/com/floragunn/*"
    reports:
      junit:
        - "target/surefire-reports/TEST-*.xml"
        - "target/failsafe-reports/TEST-*.xml"
    expire_in: 12h
  cache:
    key: mavenrepo
    paths:
      - .m2/repository

static_checks:
  stage: quality
  rules:
    - if: '$CI_COMMIT_TAG =~ /^sgctl-.*/'
      when: never
    - when: always
  script:
    - mvn -Drevision=b-$CI_COMMIT_REF_SLUG-SNAPSHOT $MAVEN_CLI_OPTS -DskipTests checkstyle:check spotbugs:check
  allow_failure: true

format_check:
  stage: quality
  rules:
    - if: '$CI_COMMIT_TAG =~ /^sgctl-.*/'
      when: never
    - when: always
  script:
    - |
      if grep -q "spotless-maven-plugin" pom.xml; then
        mvn -Drevision=b-$CI_COMMIT_REF_SLUG-SNAPSHOT $MAVEN_CLI_OPTS -DskipTests spotless:check
      else
        echo "Spotless plugin not configured; skipping format check."
      fi
  allow_failure: true

dependency_updates:
  stage: quality
  rules:
    - when: manual
      allow_failure: true
  script:
    - mvn -Drevision=b-$CI_COMMIT_REF_SLUG-SNAPSHOT $MAVEN_CLI_OPTS -DskipTests versions:display-dependency-updates
  allow_failure: true

dependency_vuln_scan:
  stage: quality
  image: owasp/dependency-check:latest
  rules:
    - when: manual
      allow_failure: true
  variables:
    DATA_DIR: "/tmp/dependency-check-data"
  script:
    - mkdir -p "$DATA_DIR" dependency-check-report
    - dependency-check.sh --project "sgctl" --format HTML --out dependency-check-report --scan .
  artifacts:
    when: always
    paths:
      - dependency-check-report
    expire_in: 3 days
  allow_failure: true

license_check:
  stage: quality
  rules:
    - when: manual
      allow_failure: true
  script:
    - |
      if grep -q "license-maven-plugin" pom.xml; then
        mvn -Drevision=b-$CI_COMMIT_REF_SLUG-SNAPSHOT $MAVEN_CLI_OPTS -DskipTests license:check
      else
        echo "License plugin not configured; skipping license check."
      fi
  allow_failure: true

secrets_scan:
  stage: quality
  image: trufflesecurity/trufflehog:latest
  rules:
    - when: manual
      allow_failure: true
  script:
    - trufflehog filesystem --no-update --fail --only-verified .
  allow_failure: true

deploy_snapshot:
  stage: package
  interruptible: true
  needs:
    - job: build
      artifacts: true
  rules:
    # Snapshot deploy disabled because credentials are unavailable.
    - when: never
  script:
    - |
      set -x
      mvn -Drevision=b-$CI_COMMIT_REF_SLUG-SNAPSHOT $MAVEN_CLI_OPTS -Dsg.plugin.skip=true -DskipTests -s settings.xml deploy
  artifacts:
    when: on_success
    expire_in: 10d
    reports:
      dotenv: build.env
  cache:
    key: mavenrepopackage
    paths:
      - .m2/repository

build_release:
  stage: build
  interruptible: true
  rules:
    - if: '$DOCKER_ONLY'
      when: never          
    - if: '$CI_COMMIT_TAG =~ /^sgctl-.*/'
      when: on_success
  script:
    # $CI_COMMIT_TAG: sgctl-1.0.0-beta-1
    - export SGCTL_RELEASE_VERSION=$(echo $CI_COMMIT_TAG | sed -n 's/^sgctl-\(.*\)/\1/p')  
    - mvn -Drevision=$SGCTL_RELEASE_VERSION $MAVEN_CLI_OPTS clean install
  artifacts:
    when: always
    paths:
      - "*/target"
      - ".m2/repository/com/floragunn/*"
    reports:
      junit:
        - "*/target/surefire-reports/TEST-*.xml"
        - "*/target/failsafe-reports/TEST-*.xml"
    expire_in: 12h
  cache:
    key: mavenrepo
    paths:
      - .m2/repository

deploy_release:
  stage: release
  interruptible: true
  rules:
    - if: '$DOCKER_ONLY'
      when: never        
    - if: '$CI_COMMIT_TAG =~ /^sgctl-.*/'
      when: on_success
  script:
    - set -x
    - export SGCTL_RELEASE_VERSION=$(echo $CI_COMMIT_TAG | sed -n 's/^sgctl-\(.*\)/\1/p')  
    - mvn -Drevision=$SGCTL_RELEASE_VERSION $MAVEN_CLI_OPTS -Dsg.plugin.skip=true -DskipTests -s settings.xml deploy
  artifacts:
    when: on_success
    expire_in: 10d
    reports:
      dotenv: build.env
  cache:
    key: mavenrepopackage
    paths:
      - .m2/repository

coverage:
  stage: package
  rules:
    - if: '$CI_COMMIT_TAG =~ /^sgctl-.*/'
      when: never
    - when: always
  image: registry.gitlab.com/haynes/jacoco2cobertura:latest
  needs: ["build"]
  dependencies:
    - build
  script:
    - mkdir -p target/site/jacoco
    - |
      if [ ! -f target/site/jacoco/jacoco.xml ]; then
        echo "Jacoco report not found at target/site/jacoco/jacoco.xml (was the build job skipped or tests not run?)"
        exit 1
      fi
    - python /opt/cover2cover.py target/site/jacoco/jacoco.xml src/main/java/ > target/site/cobertura.xml
    - cat target/site/jacoco/index.html | grep -o '<tfoot>.*</tfoot>'
  coverage: '/Total.*?([0-9]{1,3})%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: target/site/cobertura.xml
        
        
        
deploy_docker_image:
  stage: "Deploy Docker Image"
  image: docker:20.10.17
  services:
    - docker:20.10.17-dind
  rules:
    - if: '$CI_COMMIT_TAG =~ /^sgctl-.*/'
      when: on_success
    - if: '$DOCKER_ONLY'
      when: on_success
  timeout: 1h
  script:
    - |
      cd docker
      apk update && apk add bash curl 

      export SGCTL_RELEASE_VERSION=$(echo $CI_COMMIT_TAG | sed -n 's/^sgctl-\(.*\)/\1/p')  
      echo "SGCTL_RELEASE_VERSION=$SGCTL_RELEASE_VERSION"
      if [[ -z "$SGCTL_RELEASE_VERSION" ]]; then
        echo "SGCTL_RELEASE_VERSION is empty"
        exit 1
      fi
      echo "Docker logout"
      docker logout 
      
      echo "Login in into Docker Hub"      
      echo "$DOCKER_PASSWORD" | docker login --username floragunncom --password-stdin docker.io > /dev/null

      echo ""
      echo "Enable qemu-user-static to support docker multiarch builds with buildx"
      docker run --rm --privileged multiarch/qemu-user-static --reset -p yes > /dev/null

      ./build_and_push.sh "floragunncom" "docker.io" "search-guard-flx-sgctl" "$SGCTL_RELEASE_VERSION" "--build-arg SGCTL_VERSION="$SGCTL_RELEASE_VERSION" --build-arg JAVA_VERSION=$SG_JAVA_BUILD_VERSION"
  allow_failure: false        
